{% extends 'base.html' %}

{% block title %}{{ profile.user }}'s Profile{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-4 mb-4">
            <div class="card bg-dark text-light shadow">
                <div class="card-header">
                    <h2 class="text-center mb-0">Profile</h2>
                </div>
                <div class="card-body">
                    {% if not profile %}
                        <div class="alert alert-warning">
                            <p class="mb-0">Profile not found or not created yet.</p>
                        </div>
                    {% else %}
                        <div class="text-center mb-4">
                            <div class="avatar-placeholder mb-3">
                                <span class="display-4">{{ profile.user.username|first|upper }}</span>
                            </div>
                            <h3 class="mb-0">{{ profile.user.username }}</h3>
                        </div>
                        <hr>
                        
                        <div class="mb-4">
                            <h5>About</h5>
                            <small>
                                <p>{{ profile.bio|default:"No bio provided yet." }}</p>
                            </small>
                            <h5>Joined Date</h5>
                            <p><small>{{ profile.user.date_joined|date:"F d, Y" }}</small></p>
                            <h5>Last Online</h5>
                            <p><small>{{user.last_online|date:"F d, Y" }}</small></p>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {% if request.user == profile.user %}
                                <a href="{% url 'editprofile' %}" class="btn btn-primary">Edit Profile</a>
                                <a href="{% url 'changepass' %}" class="btn btn-outline-secondary">Change Password</a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        
        <div class="col-lg-8">
             <!-- Joined Rooms -->
             <div class="card bg-dark text-light shadow mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Joined Rooms</h2>
                    {% if request.user == profile.user %}
                        <a href="{% url 'joinroom' %}" class="btn btn-sm btn-primary">Join a Room</a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if profile and profile.user.members_rooms.all %}
                    
                        <div class="list-group list-group-flush">
                            {% for room in profile.user.members_rooms.all %}
                                <a href="{% url 'room' room.id %}" class="list-group-item list-group-item-action bg-dark text-light border-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1">{{ room.name }}</h5>
                                            <p class="mb-1 text-light-emphasis">{{ room.bio|truncatechars:100 }}</p>
                                            <small class="text-light-emphasis">
                                                <i class="bi bi-people-fill"></i> {{ room.members.count }} participants
                                            </small>
                                        </div>
                                        <div>
                                            
                                            <!-- incomplete tasks -->
                                             
                                             
                                            
                                            {% if not room in incompleted_todosroom %}
                                            <span class="badge rounded-pill">
                                                No Tasks
                                            {% else %}
                                            {% for i_room, count in incompleted_todosroom.items  %}
                                                    <span class="badge bg-danger rounded-pill">
                                                    Pending Tasks: {{ count }}
                                                
                                                
                                             {% endfor %}
                                            
                                            {% endif %}
                                             
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% elif profile and request.user == profile.user %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-square-text display-1 text-muted mb-3"></i>
                            <h4>No rooms joined yet</h4>
                            <p class="text-light-emphasis">You haven't joined any rooms yet.</p>
                            <a href="{% url 'joinroom' %}" class="btn btn-primary mt-2">Join a Room</a>
                        </div>
                    {% elif profile %}
                        <p class="text-light-emphasis text-center py-3">This user hasn't joined any rooms.</p>
                    {% else %}
                        <div class="alert alert-warning">
                            <p class="mb-0">Profile not found. Joined rooms cannot be displayed.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Owned Rooms Section -->
            <div class="card bg-dark text-light shadow mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Owned Rooms</h2>
                    {% if request.user == profile.user %}
                        <a href="{% url 'createroom' %}" class="btn btn-sm btn-success">Create Room</a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if profile and profile.user.admin_rooms.all %}
                        <div class="list-group list-group-flush">
                            {% for room in profile.user.admin_rooms.all %}
                                <a href="{% url 'room' room.id %}" class="list-group-item list-group-item-action bg-dark text-light border-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1">{{ room.name }}</h5>
                                            <p class="mb-1 text-light-emphasis">{{ room.bio|truncatechars:100 }}</p>
                                            <small class="text-light-emphasis">
                                                <i class="bi bi-people-fill"></i> {{ room.members.count }} participants
                                            </small>
                                        </div>
                                        <div>
                                            <span class="badge bg-success rounded-pill">Owner</span>
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% elif profile and request.user == profile.user %}
                        <div class="text-center py-4">
                            <i class="bi bi-house-door display-1 text-muted mb-3"></i>
                            <h4>No rooms created yet</h4>
                            <p class="text-light-emphasis">You haven't created any rooms yet.</p>
                            <a href="{% url 'createroom' %}" class="btn btn-success mt-2">Create a Room</a>
                        </div>
                    {% elif profile %}
                        <p class="text-light-emphasis text-center py-3">This user doesn't own any rooms.</p>
                    {% else %}
                        <div class="alert alert-warning">
                            <p class="mb-0">Profile not found. Owned rooms cannot be displayed.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
           
            
            <!-- Recent Activity -->
            <div class="card bg-dark text-light shadow">
                <div class="card-header">
                    <h3 class="mb-0">Recent Activity</h3>
                </div>
                <div class="card-body">
                    {% if profile and profile.recent_messages %}
                        <div class="list-group list-group-flush">
                            {% for message in profile.recent_messages %}
                                <div class="list-group-item bg-dark text-light border-light">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-light-emphasis">{{ message.created|date:"M d, Y" }} in <a href="{% url 'room' message.room.id %}">{{ message.room.name }}</a></small>
                                        <small class="text-light-emphasis">{{ message.created|time:"g:i A" }}</small>
                                    </div>
                                    <p class="mb-1 mt-2">{{ message.body|truncatechars:150 }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-light-emphasis text-center py-3">No recent activity to display.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
    
<style>
    .avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #375a7f;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    /* Improve text visibility on dark backgrounds */
    .text-light-emphasis {
        color: #adb5bd !important;
    }
    
    .list-group-item-action:hover {
        background-color: #2c3136 !important;
    }
    
    /* Make sure links are visible in dark theme */
    .list-group-item a {
        color: #6ea8fe;
        text-decoration: none;
    }
    
    .list-group-item a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}